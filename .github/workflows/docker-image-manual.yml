name: Docker Image CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Docker Login
      env:
        DOCKER_USER : ${{secrets.DOCKER_USERNAME}}
        DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
      run: | 
        docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
#   --------------------        
#    - name: Build Docker Image Test
#      run: |
#        pip install -r requirements.txt
#        python3 manage.py runserver
#         docker build . --file Dockerfile --tag gophermotorsports/team_homepage_test:teamHomepage-TEST-PROD
#         docker run -d gophermotorsports/team_homepage_test:teamHomepage-TEST-PROD
#         docker ps
#         echo "----------------------------------------------------------------------------------"
#         curl http://localhost:8000
#         if curl -s --head --request GET http://localhost:8000 | grep "200 OK" > /dev/null; then
#           echo "site is UP"
#           docker push gophermotorsports/team_homepage_test:teamHomepage-TEST-PROD
#        else
#          echo "site is DOWN"
#          exit 1
#        fi

    - name: Compose up
      run:  docker-compose up -d
    - name: Sleep until container launched
      uses: jakejarvis/wait-action@master
      with:
        time: '100s'
    - name: Curl localhost
      run: curl localhost:8000
          
      
#    - name: Docker Push to Test Dockerhub Repo
#     run: docker push gophermotorsports/team_homepage_test:teamHomepage-TEST-PROD
      
      
#    - name: Report Status Slack
#   - uses: ravsamhq/notify-slack-action@v1
#      if: always()
#      with:
#        status: ${{ job.status }}
#        notification_title: '{workflow} has {status_message}'
#        notify_when: 'failure'
#        mention_users: 'U0160UUNH8S,U02DLJT9DSR'
#        mention_users_when: 'failure,warnings'
#      env:
#        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: Report Status Email
      if: always()
      uses: dawidd6/action-send-mail@v2
      with:
        # mail server settings
        server_address: smtp.gmail.com
        server_port: 465
        # user credentials
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        # email subject
        subject: ${{ github.job }} job of ${{ github.repository }} has ${{ job.status }}
        # email body as text
        body: ${{ github.job }} job in worflow ${{ github.workflow }} of ${{ github.repository }} has ${{ job.status }}
        # comma-separated string, send email to
        to: apple266@umn.edu,boris040@umn.edu
        # from email name
        from: github
        
#    - name: Test if Site is Successfully Curl'd
#      run: |
#        if curl /URL/ works; then
#         docker build. --file Dockerfile --tag gophermotorsports/team_homepage:teamHomepage-PROD
#          docker push ${{secrets.DOCKER_USERNAME}}/team_homepage:teamHomepage-PROD
#        else
#          Alert dev.

